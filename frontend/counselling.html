<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Counselling - Unified Campus System</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 0;
        }

        .dashboard-container {
            display: flex;
        }

        .main-content {
            flex: 1;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .profile-btn {
            background: none;
            border: none;
            color: #2c3e50;
            font-size: 16px;
            cursor: pointer;
        }

        .counselling-form,
        .scheduled-sessions {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .slots button {
            display: block;
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #2c3e50;
            color: white;
            font-size: 16px;
            cursor: pointer;
        }

        .slots button:hover {
            background-color: #34495e;
        }
    </style>
</head>

<body onload="checkUserRole()">
    <div class="dashboard-container">
        <aside class="sidebar">
            <h2>Campus System</h2>
            <ul>
                <li><a href="homepage.html"><i class="fas fa-home"></i> Home</a></li>
                <li><a href="dash.html"><i class="fas fa-chart-line"></i> Dashboard</a></li>
                <li><a href="#"><i class="fas fa-utensils"></i> Canteen</a></li>
                <li><a href="counselling.html"><i class="fas fa-user-md"></i> Counselling</a></li>
                <li><a href="community.html"><i class="fas fa-users"></i> Community</a></li>
                <li><a href="index.html" class="logout"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
        </aside>

        <main class="main-content">
            <header>
                <h1>Counselling</h1>
                <!-- <button class="profile-btn"><i class="fas fa-user-circle"></i> Profile</button> -->
            </header>

            <div id="studentView" style="display: none;">
                <!-- <h2>Book a Counselling Slot</h2>
                <label>Select Counsellor:</label>
                <select id="counsellorSelect"></select>
                <div class="slots" id="slots"></div>
                <div id="studentBookings" style="display: none;">
                    <h2>My Booked Slots</h2>
                    <ul id="myBookedSlots"></ul>
                </div> -->

                <h2 style="color: #2c3e50; text-align: center;">üìÖ Book a Counselling Slot</h2>

                <!-- üîπ Select Date -->
                <div style="margin-bottom: 10px;">
                    <label style="font-weight: bold;">üìÜ Select Date:</label>
                    <input type="date" id="datePicker"
                        style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ccc;">
                </div>

                <!-- üîπ Select Time -->
                <div style="margin-bottom: 10px;">
                    <label style="font-weight: bold;">‚è∞ Select Time:</label>
                    <select id="timePicker"
                        style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ccc;">
                        <option value="09:30">9:30 AM</option>
                        <option value="10:00">10:00 AM</option>
                        <option value="10:30">10:30 AM</option>
                        <option value="11:00">11:00 AM</option>
                        <option value="11:30">11:30 AM</option>
                        <option value="12:00">12:00 PM</option>
                        <option value="12:30">12:30 PM</option>
                        <option value="13:00">1:00 PM</option>
                        <option value="13:30">1:30 PM</option>
                        <option value="14:00">2:00 PM</option>
                        <option value="14:30">2:30 PM</option>
                        <option value="15:00">3:00 PM</option>
                        <option value="15:30">3:30 PM</option>
                    </select>
                </div>

                <!-- üîπ Select Counsellor -->
                <div style="margin-bottom: 10px;">
                    <label style="font-weight: bold;">üë®‚Äç‚öïÔ∏è Select Counsellor:</label>
                    <select id="counsellorSelect"
                        style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ccc;">
                        <option value="" disabled selected>Choose a Counsellor</option>
                    </select>
                </div>

                <!-- üîπ Book Button -->
                <div style="text-align: center;">
                    <button onclick="bookSlot()"
                        style="background-color: #2c3e50; color: white; padding: 12px 20px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer;">
                        ‚úÖ Book Slot
                    </button>
                </div>

                <!-- üîπ Student's Booked Slots -->
                <div id="studentBookings" style="display: none; margin-top: 20px;">
                    <h2 style="color: #2c3e50;">üìã My Booked Slots</h2>
                    <ul id="myBookedSlots" style="list-style: none; padding: 0;"></ul>
                </div>

            </div>

            <div id="counsellorView" style="display: none;">
                <h2>Booked Slots</h2>
                <ul id="bookedSlots"></ul>
            </div>
        </main>
    </div>

    <script>
        async function loadAvailableCounsellors() {
            try {
                const response = await fetch("http://localhost:5000/api/counselling/available-counsellors");
                if (!response.ok) {
                    throw new Error("Failed to fetch counsellors");
                }

                const counsellors = await response.json();
                console.log("Counsellors Loaded:", counsellors); // Debugging log

                const counsellorSelect = document.getElementById("counsellorSelect");
                counsellorSelect.innerHTML = ""; // Clear previous options

                if (counsellors.length === 0) {
                    const option = document.createElement("option");
                    option.textContent = "No counsellors available";
                    option.disabled = true;
                    counsellorSelect.appendChild(option);
                    return;
                }

                counsellors.forEach(counsellor => {
                    const option = document.createElement("option");
                    option.value = counsellor.id;
                    option.textContent = `${counsellor.first_name} ${counsellor.last_name}`;
                    counsellorSelect.appendChild(option);
                });
            } catch (error) {
                console.error("Error loading counsellors:", error);
            }
        }

        function checkUserRole() {
            const role = sessionStorage.getItem('role');
            if (role === 'student') {
                document.getElementById('studentView').style.display = 'block';
                loadAvailableCounsellors();
                loadAvailableSlots();
            } else if (role === 'counselor') {
                document.getElementById('counsellorView').style.display = 'block';
                fetchBookedSlots();
            }
        }

        // function loadAvailableSlots() {
        //     const startTime = new Date();
        //     startTime.setHours(9, 30, 0);
        //     const endTime = new Date();
        //     endTime.setHours(16, 0, 0);
        //     const slotsContainer = document.getElementById("slots");
        //     slotsContainer.innerHTML = "";

        //     while (startTime <= endTime) {
        //         const slotTime = startTime.toISOString().slice(0, 16);
        //         const slotButton = document.createElement("button");
        //         slotButton.textContent = new Date(slotTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        //         slotButton.onclick = () => bookSlot(slotTime);
        //         slotsContainer.appendChild(slotButton);
        //         startTime.setMinutes(startTime.getMinutes() + 30);
        //     }
        // }


        function loadAvailableSlots() {
            const startTime = new Date();
            startTime.setHours(9, 30, 0, 0); // ‚úÖ Set exact time (9:30 AM)

            const endTime = new Date();
            endTime.setHours(16, 0, 0, 0); // ‚úÖ Set exact time (4:00 PM)

            const slotsContainer = document.getElementById("slots");
            slotsContainer.innerHTML = "";

            while (startTime <= endTime) {
                const slotTime = new Date(startTime); // ‚úÖ Create a copy to avoid mutation

                // üîπ Format time correctly using `toLocaleTimeString`
                const slotButton = document.createElement("button");
                slotButton.textContent = slotTime.toLocaleTimeString("en-US", {
                    hour: "2-digit",
                    minute: "2-digit",
                    hour12: true, // ‚úÖ Ensures AM/PM format
                });

                slotButton.onclick = () => bookSlot(slotTime.toISOString()); // ‚úÖ Pass full ISO string for accuracy
                slotsContainer.appendChild(slotButton);

                startTime.setMinutes(startTime.getMinutes() + 30); // ‚úÖ Increment by 30 minutes
            }
        }







        // async function bookSlot(slotTime) {
        //     const studentId = sessionStorage.getItem('id');
        //     const counsellorId = document.getElementById("counsellorSelect").value;

        //     if (!studentId) return alert("Please log in first!");
        //     if (!counsellorId) return alert("Please select a counsellor!");

        //     try {
        //         const response = await fetch("http://localhost:5000/api/counselling/book-slot", {
        //             method: "POST",
        //             headers: { "Content-Type": "application/json" },
        //             body: JSON.stringify({ student_id: studentId, counsellor_id: counsellorId, session_date_time: slotTime })
        //         });

        //         const data = await response.json();
        //         if (response.ok) {
        //             alert("Slot booked successfully!");
        //             window.location.reload();
        //         } else {
        //             alert(data.error || "Failed to book slot");
        //         }
        //     } catch (error) {
        //         console.error("Error booking slot:", error);
        //         alert("Error booking slot. Try again.");
        //     }
        // }


        // async function bookSlot(slotTime) {
        //     const studentId = sessionStorage.getItem("id");
        //     const counsellorId = document.getElementById("counsellorSelect").value;

        //     if (!studentId) return alert("Please log in first!");
        //     if (!counsellorId) return alert("Please select a counsellor!");

        //     // ‚úÖ Ensure Local Time Instead of UTC
        //     const selectedTime = new Date(slotTime);
        //     selectedTime.setMinutes(selectedTime.getMinutes() - selectedTime.getTimezoneOffset()); // Adjust for timezone offset

        //     const formattedDateTime = selectedTime.getFullYear() + "-" +
        //         String(selectedTime.getMonth() + 1).padStart(2, "0") + "-" +
        //         String(selectedTime.getDate()).padStart(2, "0") + " " +
        //         String(selectedTime.getHours()).padStart(2, "0") + ":" +
        //         String(selectedTime.getMinutes()).padStart(2, "0") + ":" +
        //         "00";

        //     try {
        //         const response = await fetch("http://localhost:5000/api/counselling/book-slot", {
        //             method: "POST",
        //             headers: { "Content-Type": "application/json" },
        //             body: JSON.stringify({
        //                 student_id: studentId,
        //                 counsellor_id: counsellorId,
        //                 session_date_time: formattedDateTime // ‚úÖ Sends Correct Local Time Format
        //             })
        //         });

        //         const data = await response.json();
        //         if (response.ok) {
        //             alert("Slot booked successfully!");
        //             window.location.reload();
        //         } else {
        //             alert(data.error || "Failed to book slot");
        //         }
        //     } catch (error) {
        //         console.error("Error booking slot:", error);
        //         alert("Error booking slot. Try again.");
        //     }
        // }



        async function bookSlot() {
            const studentId = sessionStorage.getItem("id");
            const counsellorId = document.getElementById("counsellorSelect").value;
            const selectedDate = document.getElementById("datePicker").value; // Get selected date
            const selectedTime = document.getElementById("timePicker").value; // Get selected time

            if (!studentId) return alert("‚ùå Please log in first!");
            if (!counsellorId) return alert("‚ùå Please select a counsellor!");
            if (!selectedDate) return alert("‚ùå Please select a date!");
            if (!selectedTime) return alert("‚ùå Please select a time!");

            // üîπ Convert selected date & time into a JavaScript Date object
            let selectedDateTime = new Date(`${selectedDate}T${selectedTime}:00`);

            // üîπ Add 5 hours 30 minutes to fix offset issue
            selectedDateTime.setHours(selectedDateTime.getHours() + 11);
            // selectedDateTime.setMinutes(selectedDateTime.getMinutes() + );

            // ‚úÖ Format it as "YYYY-MM-DD HH:MM:SS" for MySQL
            const formattedDateTime = selectedDateTime.getFullYear() + "-" +
                String(selectedDateTime.getMonth() + 1).padStart(2, "0") + "-" +
                String(selectedDateTime.getDate()).padStart(2, "0") + " " +
                String(selectedDateTime.getHours()).padStart(2, "0") + ":" +
                String(selectedDateTime.getMinutes()).padStart(2, "0") + ":00";

            console.log("üìå Debugging: Adjusted Time ‚Üí", formattedDateTime); // Debugging output

            try {
                const response = await fetch("http://localhost:5000/api/counselling/book-slot", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        student_id: studentId,
                        counsellor_id: counsellorId,
                        session_date_time: formattedDateTime // ‚úÖ Sends corrected time
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    alert("‚úÖ Slot booked successfully!");
                    window.location.reload();
                } else {
                    alert(data.error || "‚ö†Ô∏è Failed to book slot");
                }
            } catch (error) {
                console.error("‚ùå Error booking slot:", error);
                alert("‚ùå Error booking slot. Try again.");
            }
        }










        // // Fetch booked slots for counsellors
        // async function fetchBookedSlots() {
        //     try {
        //         const response = await fetch("http://localhost:5000/api/counselling/booked-slots");
        //         if (!response.ok) throw new Error("Failed to fetch booked slots");

        //         const slots = await response.json();
        //         const slotsContainer = document.getElementById("bookedSlots");
        //         slotsContainer.innerHTML = "";

        //         slots.forEach(slot => {
        //             const li = document.createElement("li");
        //             li.innerHTML = `
        //                 <strong>Student:</strong> ${slot.Student.first_name} ${slot.Student.last_name}<br>
        //                 <strong>Time:</strong> ${slot.session_date_time}<br>
        //                 <strong>Feedback:</strong> ${slot.feedback || 'No feedback yet'}
        //             `;
        //             slotsContainer.appendChild(li);
        //         });
        //     } catch (error) {
        //         console.error("Error fetching booked slots:", error);
        //     }
        // }

        // async function fetchBookedSlots() {
        //     try {
        //         const token = sessionStorage.getItem("token"); // Get token from sessionStorage
        //         const response = await fetch("http://localhost:5000/api/counselling/booked-slots", {
        //             method: "GET",
        //             headers: {
        //                 "Authorization": `Bearer ${token}`,  // üîπ Send token with request
        //                 "Content-Type": "application/json",
        //             },
        //         });

        //         if (!response.ok) throw new Error("Failed to fetch booked slots");

        //         const slots = await response.json();
        //         const slotsContainer = document.getElementById("bookedSlots");
        //         slotsContainer.innerHTML = "";

        //         slots.forEach(slot => {
        //             // üîπ Convert date-time to readable format
        //             const formattedDateTime = slot.session_date_time.replace("T", " ").replace("Z", "");

        //             const li = document.createElement("li");
        //             li.style.padding = "10px";
        //             li.style.marginBottom = "10px";
        //             li.style.borderRadius = "6px";
        //             li.style.backgroundColor = "#f4f4f9";
        //             li.style.boxShadow = "0 2px 5px rgba(0, 0, 0, 0.1)";
        //             li.style.display = "flex";
        //             li.style.flexDirection = "column";
        //             li.style.justifyContent = "space-between";

        //             li.innerHTML = `
        //             <div style="margin-bottom: 5px;">
        //                 <strong style="color: #2c3e50;">üë§ Student:</strong> ${slot.Student.first_name} ${slot.Student.last_name}
        //             </div>
        //             <div style="margin-bottom: 5px;">
        //                 <strong style="color: #2c3e50;">‚è∞ Time:</strong> ${formattedDateTime}
        //             </div>
        //             <div style="margin-bottom: 5px;">
        //                 <strong style="color: #2c3e50;">üí¨ Feedback:</strong> <span style="color: ${slot.feedback ? 'green' : 'gray'};">${slot.feedback || 'No feedback yet'}</span>
        //             </div>
        //         `;

        //             slotsContainer.appendChild(li);
        //         });

        //     } catch (error) {
        //         console.error("Error fetching booked slots:", error);
        //     }
        // }





        async function fetchBookedSlots() {
            try {
                const token = sessionStorage.getItem("token"); // Get token from sessionStorage
                const response = await fetch("http://localhost:5000/api/counselling/booked-slots", {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${token}`,  // üîπ Send token with request
                        "Content-Type": "application/json",
                    },
                });

                if (!response.ok) throw new Error("Failed to fetch booked slots");

                const slots = await response.json();
                const slotsContainer = document.getElementById("bookedSlots");
                slotsContainer.innerHTML = "";

                slots.forEach(slot => {
                    // üîπ Convert date-time to readable format
                    const formattedDateTime = slot.session_date_time.replace("T", " ").replace("Z", "");

                    const li = document.createElement("li");
                    li.style.padding = "10px";
                    li.style.marginBottom = "10px";
                    li.style.borderRadius = "6px";
                    li.style.backgroundColor = "#f4f4f9";
                    li.style.boxShadow = "0 2px 5px rgba(0, 0, 0, 0.1)";
                    li.style.display = "flex";
                    li.style.flexDirection = "column";
                    li.style.justifyContent = "space-between";

                    li.innerHTML = `
                <div style="margin-bottom: 5px;">
                    <strong style="color: #2c3e50;">üë§ Student:</strong> ${slot.Student.first_name} ${slot.Student.last_name}
                </div>
                <div style="margin-bottom: 5px;">
                    <strong style="color: #2c3e50;">‚è∞ Time:</strong> ${formattedDateTime}
                </div>
                <div style="margin-bottom: 5px;">
                    <strong style="color: #2c3e50;">üí¨ Feedback:</strong> 
                    <span style="color: ${slot.feedback ? 'green' : 'gray'};">${slot.feedback || 'No feedback yet'}</span>
                </div>
                ${!slot.feedback ? `
                    <textarea id="feedback-${slot.session_id}" placeholder="Add feedback..." 
                        style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ccc; margin-top: 5px;"></textarea>
                    <button onclick="submitFeedback(${slot.session_id})" 
                        style="background-color: #2c3e50; color: white; padding: 6px 10px; border: none; border-radius: 5px; margin-top: 5px; cursor: pointer;">
                        Submit Feedback
                    </button>
                ` : ""}
            `;

                    slotsContainer.appendChild(li);
                });

            } catch (error) {
                console.error("Error fetching booked slots:", error);
            }
        }

        // üîπ Submit Feedback Function
        async function submitFeedback(sessionId) {
            const feedbackText = document.getElementById(`feedback-${sessionId}`).value.trim();
            if (!feedbackText) return alert("Feedback cannot be empty!");

            try {
                const response = await fetch(`http://localhost:5000/api/counselling/add-feedback/${sessionId}`, {
                    method: "PUT",
                    headers: {
                        "Authorization": `Bearer ${sessionStorage.getItem("token")}`,
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ feedback: feedbackText }),
                });

                if (!response.ok) throw new Error("Failed to submit feedback");

                alert("Feedback submitted successfully!");
                fetchBookedSlots(); // üîπ Refresh the list
            } catch (error) {
                console.error("Error submitting feedback:", error);
                alert("Error submitting feedback. Try again.");
            }
        }










        // // üîπ Fetch and display booked slots for the logged-in student
        // async function fetchStudentBookedSlots() {
        //     try {
        //         const response = await fetch("http://localhost:5000/api/counselling/student-booked-slots", {
        //             method: "GET",
        //             headers: {
        //                 "Content-Type": "application/json",
        //                 "Authorization": `Bearer ${sessionStorage.getItem("token")}`, // ‚úÖ Send Auth Token
        //             },
        //         });

        //         if (!response.ok) {
        //             throw new Error("Failed to fetch student booked slots");
        //         }

        //         const slots = await response.json();
        //         const slotsContainer = document.getElementById("myBookedSlots");
        //         slotsContainer.innerHTML = "";

        //         if (slots.length === 0) {
        //             slotsContainer.innerHTML = "<li>No booked slots</li>";
        //             return;
        //         }

        //         slots.forEach(slot => {
        //             const li = document.createElement("li");
        //             li.innerHTML = `
        //         <strong>Counsellor:</strong> ${slot.Counsellor.first_name} ${slot.Counsellor.last_name}<br>
        //         <strong>Time:</strong> ${slot.session_date_time}
        //     `;
        //             slotsContainer.appendChild(li);
        //         });

        //         document.getElementById("studentBookings").style.display = "block"; // ‚úÖ Show section
        //     } catch (error) {
        //         console.error("Error fetching student booked slots:", error);
        //     }
        // }
        async function fetchStudentBookedSlots() {
            try {
                const response = await fetch("http://localhost:5000/api/counselling/student-booked-slots", {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${sessionStorage.getItem("token")}`, // ‚úÖ Send Auth Token
                    },
                });

                if (!response.ok) {
                    throw new Error("Failed to fetch student booked slots");
                }

                const slots = await response.json();
                const slotsContainer = document.getElementById("myBookedSlots");
                slotsContainer.innerHTML = "";

                if (slots.length === 0) {
                    slotsContainer.innerHTML = "<li>No booked slots</li>";
                    return;
                }

                // slots.forEach(slot => {
                //     // üîπ Convert date-time to readable format
                //     const formattedDateTime = slot.session_date_time.replace("T", " ").replace("Z", "");

                //     const li = document.createElement("li");
                //     li.innerHTML = `
                //     <strong>Counsellor:</strong> ${slot.Counsellor.first_name} ${slot.Counsellor.last_name}<br>
                //     <strong>Time:</strong> ${formattedDateTime}
                // `;
                //     slotsContainer.appendChild(li);
                // });

                slots.forEach(slot => {
                    // üîπ Convert date-time to a user-friendly format
                    const formattedDateTime = slot.session_date_time.replace("T", " ").replace("Z", "");

                    const li = document.createElement("li");
                    li.style.padding = "12px";
                    li.style.marginBottom = "10px";
                    li.style.borderRadius = "6px";
                    li.style.backgroundColor = "#f4f4f9";
                    li.style.boxShadow = "0 2px 5px rgba(0, 0, 0, 0.1)";
                    li.style.display = "flex";
                    li.style.flexDirection = "column";
                    li.style.justifyContent = "space-between";
                    li.style.borderLeft = "5px solid #2c3e50";

                    li.innerHTML = `
                    <div style="margin-bottom: 5px;">
                        <strong style="color: #2c3e50;">üë®‚Äç‚öïÔ∏è Counsellor:</strong> ${slot.Counsellor.first_name} ${slot.Counsellor.last_name}
                    </div>
                    <div style="margin-bottom: 5px;">
                        <strong style="color: #2c3e50;">‚è∞ Scheduled Time:</strong> <span style="color: #007bff;">${formattedDateTime}</span>
                    </div>
                `;

                    slotsContainer.appendChild(li);
                });


                document.getElementById("studentBookings").style.display = "block"; // ‚úÖ Show section
            } catch (error) {
                console.error("Error fetching student booked slots:", error);
            }
        }





        // üîπ Modify `checkUserRole` function to also fetch student bookings
        function checkUserRole() {
            const role = sessionStorage.getItem("role");

            if (role === "student") {
                document.getElementById("studentView").style.display = "block";
                fetchStudentBookedSlots(); // ‚úÖ Fetch student bookings
                loadAvailableCounsellors();
                loadAvailableSlots();
            } else if (role === "counselor") {
                document.getElementById("counsellorView").style.display = "block";
                fetchBookedSlots();
            }
        }


        // Handle logout
        document.querySelector(".logout").addEventListener("click", () => {
            // Clear sessionStorage
            sessionStorage.removeItem("token");
            sessionStorage.removeItem("username");
            sessionStorage.removeItem("fname");
            sessionStorage.removeItem("lname");
            sessionStorage.removeItem("id");

            // Redirect to the login page
            window.location.href = "auth.html";
        });


    </script>
</body>

</html>